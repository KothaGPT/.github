name: AI Project CI

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [ main ]

permissions:
  contents: read
  id-token: write

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]
    steps:
      - uses: actions/checkout@v4

      - name: Check for Python project files
        id: check-files
        run: |
          if [ -f requirements.txt ] || [ -f pyproject.toml ] || [ -f setup.py ] || find . -name "*.py" -type f | head -1 | grep -q .; then
            echo "Python project detected"
            echo "run_tests=true" >> $GITHUB_OUTPUT
          else
            echo "No Python project files found, skipping tests"
            echo "run_tests=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Python ${{ matrix.python-version }}
        if: steps.check-files.outputs.run_tests == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install AI dependencies
        if: steps.check-files.outputs.run_tests == 'true'
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then python -m pip install -r requirements.txt; fi
          python -m pip install black flake8 pytest torch transformers datasets

      - name: Cache models
        if: steps.check-files.outputs.run_tests == 'true'
        uses: actions/cache@v4
        with:
          path: ~/.cache/huggingface
          key: ${{ runner.os }}-models-${{ hashFiles('**/models/**') }}
          restore-keys: |
            ${{ runner.os }}-models-

      - name: Lint with black
        if: steps.check-files.outputs.run_tests == 'true'
        run: black --check --diff .

      - name: Lint with flake8
        if: steps.check-files.outputs.run_tests == 'true'
        run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: Run unit tests
        if: steps.check-files.outputs.run_tests == 'true'
        run: python -m pytest -q

      - name: Validate model configurations
        if: steps.check-files.outputs.run_tests == 'true'
        run: |
          # Add custom validation for AI models
          python -c "
          import json
          import os
          for root, dirs, files in os.walk('.'):
              for file in files:
                  if file.endswith('.json') and 'config' in file.lower():
                      with open(os.path.join(root, file), 'r') as f:
                          json.load(f)
          print('All model configs are valid JSON')
          "

      - name: Check for large files (models/data)
        if: steps.check-files.outputs.run_tests == 'true'
        run: |
          # Warn if large files are being committed
          large_files=$(find . -type f -size +50M -not -path "./.git/*")
          if [ ! -z "$large_files" ]; then
            echo "Warning: Large files detected:"
            echo "$large_files"
          fi

      - name: Skip CI for non-Python projects
        if: steps.check-files.outputs.run_tests == 'false'
        run: |
          echo "This repository does not appear to be a Python project. CI checks skipped."